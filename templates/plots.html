{% extends "base.html" %}

{% block title %}Log Game Results{% endblock %}

{% block head %}

<style>



    h1,
    h2 {
        font-size: 2.5rem;
    }




    .stats-container h3 {
        font-size: 1.8rem;
        font-family: Arial, sans-serif;
        color: white;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .checkbox-container {
        margin-bottom: 10px;
        background-color: rgba(139, 69, 19, 0.9);
    }

    .checkbox-container label {
        display: block;
        margin: 8px 0;
    }

    .checkbox-container input[type="checkbox"] {
        margin-right: 10px;
    }

    button {
        background-color: #e74c3c;
        /* Mars red */
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        margin: 0 10px;
        text-decoration: none;
    }

    button:hover {
        background-color: #e67e22;
    }

    .btn-primary {
        background-color: #e74c3c;
        /* Mars red */
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        margin: 0 10px;
        text-decoration: none;
    }

    .btn-primary:hover {
        background-color: #e67e22;
    }



    .checkbox-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        border-radius: 8px;
        background-color: rgba(50, 15, 15, 0.2);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        color: white;
    }

    .checkbox-container label {
        font-size: 1rem;
        margin-left: 8px;
    }

    input[type="checkbox"] {
        transform: scale(1.2);
    }


    table {
        width: 100%;
        margin-top: 2px;
        border-collapse: collapse;
        background-color: #ffffff;
    }



    th.asc::after {
        content: " ↓";
    }

    th.desc::after {
        content: " ↑";
    }

    th {
        background-color: #b22222;
        /* Darker red for header cells */
        font-size: 1.1rem;
        font-weight: bold;
    }

    tr:nth-child(even) {
        background-color: rgba(139, 69, 19, 0.9);
        /* Mars-like brown for even rows */
    }

    tr:nth-child(odd) {
        background-color: rgba(255, 99, 71, 0.9);
        /* Lighter red for odd rows */
    }

    tr:hover {
        background-color: rgba(255, 69, 0, 0.7);
        /* Highlight row on hover */
    }

    @media (max-width: 768px) {
        .container {
            grid-template-columns: 1fr;
        }
    }


</style>

<script>
async function fetchPlotData(players, seasonParam) {
    const url = new URL('/generate_plot', window.location.origin);
    players.forEach(player => url.searchParams.append('players', player));

    // Use the passed season parameter if available, otherwise read from select
    const season = seasonParam || document.getElementById("season-select").value;
    if (season && season !== "all") {
        url.searchParams.append("season", season);
    }

    const response = await fetch(url);
    const data = await response.json();

        console.log("Received stats:", data);
        const currentWinner = data.stats['Current Winner'];
        console.log("Current Winner:", currentWinner);

        const plotImage = document.getElementById("plot_image");
        plotImage.src = "data:image/png;base64," + data.plot_url;

        const plotImage2 = document.getElementById("plot_image2");
        plotImage2.src = "data:image/png;base64," + data.plot2_url;

        updateWinner(currentWinner)









        const playerStatsTable = document.getElementById("player_stats_table_body");
        playerStatsTable.innerHTML = "";  // Clear existing table content
        const stats = data.stats;
        const totalWins = stats['Total Wins'];
        const totalPoints = stats['Total Points'];

        // Find the player with the most wins
        let maxWins = -1;
        let playerWithMaxWins = "";

        const playerStats = stats['Player Stats'];
        for (const player in playerStats) {
            const row = document.createElement("tr");


            const playerCell = document.createElement("td");
            playerCell.textContent = player;
            row.appendChild(playerCell);

            const totalGamesCell = document.createElement("td");
            totalGamesCell.textContent = playerStats[player].total_games;
            row.appendChild(totalGamesCell);

            const totalWinsCell = document.createElement("td");
            totalWinsCell.textContent = parseInt(playerStats[player].total_wins, 10) || 0; // Convert to int
            row.appendChild(totalWinsCell);

            const totalPointsCell = document.createElement("td");
            totalPointsCell.textContent = playerStats[player].total_points.toFixed(0);
            row.appendChild(totalPointsCell);

            const meanPointsCell = document.createElement("td");
            meanPointsCell.textContent = playerStats[player].mean_points.toFixed(1);
            row.appendChild(meanPointsCell);

            const stdPointsCell = document.createElement("td");
            stdPointsCell.textContent = playerStats[player].std_points.toFixed(1);
            row.appendChild(stdPointsCell);

            const maxScoreCell = document.createElement("td");
            maxScoreCell.textContent = playerStats[player].max_game_score.toFixed(0);
            row.appendChild(maxScoreCell);

            const minScoreCell = document.createElement("td");
            minScoreCell.textContent = playerStats[player].min_game_score.toFixed(0);
            row.appendChild(minScoreCell);

            // Sort after table has been filled
            //sortTable(2);



            playerStatsTable.appendChild(row);

            if (totalWins[player] > maxWins) {
                maxWins = totalWins[player];
                playerWithMaxWins = player;

            }
        }


    }



document.addEventListener("DOMContentLoaded", () => {
    const seasonSelect = document.getElementById("season-select");
    const savedSeason = localStorage.getItem("selectedSeason") || "1";

    // Apply the saved season
    if (seasonSelect) {
        seasonSelect.value = savedSeason;
    }

    // Apply theme based on saved season
    if (savedSeason === "2") {
        document.body.classList.add("venus-theme");
    } else {
        document.body.classList.remove("venus-theme");
    }
// Update the "Current Son of ..." header
const winnerTitle = document.getElementById("current-winner-title");
winnerTitle.textContent = (savedSeason === "2") ? "CURRENT SON OF VENUS" : "CURRENT SON OF MARS";

    

    // Fetch plots using saved season
    const selectedPlayers = Array.from(document.querySelectorAll('input[name="players"]:checked'))
        .map(input => input.value);

    fetchPlotData(selectedPlayers, savedSeason);
});




    let currentWinner = null;
    const musicFiles = {
        "Frederik": "static/music/frederikWin.mp3",
        "Magnus": "static/music/magnusWin.mp3",
        "Best": "static/music/bestWin.mp3",
        "Morten": "static/music/mortenWin.mp3",
        "Raschke": "static/music/raschkeWin.mp3",
        "Alstrup": "static/music/alstrupWin.mp3"
    };


    function updateWinner(winner) {
        if (currentWinner !== winner) {
            currentWinner = winner;

            const source = document.getElementById("music-source");
            const audio = document.getElementById("background-music");
            const imageContainer = document.getElementById("image-container");

            // Update music source
            source.src = musicFiles[winner] || "";
            audio.load();

            if (localStorage.getItem('musicPlaying') === 'true') {
                audio.play().catch(() => { });
            }

            // Update player image
            imageContainer.innerHTML = "";
            const image = document.createElement("img");
            image.src = `/static/images/${currentWinner}.png`;
            image.alt = `Player with the most wins: ${currentWinner}`;
            imageContainer.appendChild(image);
        }
    }
    function sortTable(columnIndex) {
        const table = document.querySelector("table");
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.querySelectorAll("tr"));

        const headers = table.querySelectorAll("th");
        const currentHeader = headers[columnIndex];
        const isDescending = currentHeader.classList.contains("desc");

        // Clear sort classes from all headers
        headers.forEach(th => th.classList.remove("asc", "desc"));

        // Determine sort direction (default to descending on first click)
        const sortDirection = isDescending ? 'asc' : 'desc';

        // Sort rows
        rows.sort((a, b) => {
            const cellA = a.children[columnIndex].textContent.trim();
            const cellB = b.children[columnIndex].textContent.trim();

            const valueA = isNaN(cellA) ? cellA.toLowerCase() : parseFloat(cellA);
            const valueB = isNaN(cellB) ? cellB.toLowerCase() : parseFloat(cellB);

            if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
            if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        // Apply new sort direction class
        currentHeader.classList.add(sortDirection);

        // Re-append sorted rows
        rows.forEach(row => tbody.appendChild(row));
    }

    // Handle initial user interaction to allow audio autoplay
    function enableAudioPlayback() {
        const audio = document.getElementById('background-music');
        if (audio.paused) {
            audio.play().catch(() => { });
            localStorage.setItem('musicPlaying', 'true');
        }
        document.removeEventListener('mousedown', enableAudioPlayback);
        document.removeEventListener('keydown', enableAudioPlayback);
        document.removeEventListener('scroll', enableAudioPlayback);
    }

    document.addEventListener('mousedown', enableAudioPlayback, { once: true });
    document.addEventListener('keydown', enableAudioPlayback, { once: true });
    document.addEventListener('scroll', enableAudioPlayback, { once: true });



</script>


<!-- Audio Player -->
<audio id="background-music" loop>
    <source id="music-source" src="" type="audio/mp3">
    Your browser does not support the audio element.
</audio>
</head>

<body>


    <div style="text-align: center; margin: 10px; padding-top: 60px;">
        <label for="season-select">Choose Season:</label>
<select id="season-select" class="season-select" onchange="handlePlayerSelection()">
    <option value="1">Season of Mars</option>
    <option value="2">Season of Venus</option>
</select>



    <div class="container">

        <div class="plot-container">
            <!-- Graph -->
            <h2>Accumulated game scores</h2>
            <img id="plot_image" alt="Accumulated Game Scores Plot" style="max-width: 100%; height: auto;" />
            <h2>Game scores</h2>
            <img id="plot_image2" alt="Game Scores Plot" style="max-width: 100%; height: auto;" />
            <!-- Player Selection Form -->
            <div class="stats-container" style="margin-top: 10px; width: 100%; text-align: center;">
                <form id="player-selection-form" onsubmit="event.preventDefault(); handlePlayerSelection();">
                    <h2> Select Players to Plot:</h2>
                        <div class="checkbox-container">
                            {% for player in players %}
                            <label style="margin: 0 10px;">
                                <input type="checkbox" name="players" value="{{ player }}" checked>
                                {{ player }}
                            </label>
                            {% endfor %}
                        </div>
                        <button type="submit">Generate Plot</button>
                </form>
            </div>
        </div>
        <div class="containerImageColumn" style="flex: 1; margin-left: 20px;">
            <h2 id="current-winner-title">CURRENT SON</h2>
            <div id="image-container" style="text-align: center;"></div>
            <h2>
                General Stats
            </h2>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Player</th>
                        <th onclick="sortTable(1)">Total Games</th>
                        <th onclick="sortTable(2)">Total Wins</th>
                        <th onclick="sortTable(3)">Total Points</th>
                        <th onclick="sortTable(4)">Mean Points</th>
                        <th onclick="sortTable(5)">Std of Points</th>
                        <th onclick="sortTable(6)">Max Game Score</th>
                        <th onclick="sortTable(7)">Min Game Score</th>
                    </tr>
                </thead>
                <tbody id="player_stats_table_body"></tbody>
            </table>
        </div>
    </div>
    </div>


</body>

</html>
{% endblock %}