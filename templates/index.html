{% extends "base.html" %}

{% block title %}Log Game Results{% endblock %}

{% block head %}
<style>
    body {
        color: white;
    }

    .container {
        background: rgba(50, 15, 15, 0.85);
        border-radius: 15px;
        margin-top: 150px;
        padding: 40px 60px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        max-width: 650px;
        margin-left: auto;
        margin-right: auto;
        position: relative;
    }

 

 



    table {
        width: 100%;
        margin-bottom: 20px;
        border-collapse: collapse;
        border: none;
        margin-top: 20px;
    }

    th, td {
        padding: 4px 8px 0px;
        text-align: center;
        color: white;
        border: none;
    }

    th {
        background-color: #333;
        padding: 10px;

    }

    button:hover {
        background-color: #e67e22;
    }

    #max_players_buttons button {
        margin-right: 5px;
        padding: 10px 20px;
        background-color: rgba(120, 120, 120, 0.7);
        color: white;
        border: 1px solid transparent;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    #max_players_buttons button:hover {
        background-color: rgba(100, 100, 100, 0.8);
    }

    #max_players_buttons button.active {
        color: white;
        border: 2px solid orange;
    }

    .button-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }

    #error_message {
        color: #e74c3c;
        font-size: 1.2rem;
        margin-top: 10px;
        text-align: center;
    }

    /* Dialog styles */
    .dialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .dialog-content {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 8px;
        text-align: center;
        min-width: 250px;
        max-width: 80%;
        color: #C1440E;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        animation: popIn 0.2s ease-in-out;
        position: relative;
    }

    .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        cursor: pointer;
        font-size: 20px;
    }

    @keyframes popIn {
        0% { transform: scale(0.7); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 768px) {
        .container {
            width: 95%;
            padding: 20px;
        }

  
    }
</style>
{% endblock %}

{% block content %}
<div class="container_simple">
    <h1>Log Board Game Results</h1>
    <form method="POST" action="/log" onsubmit="handleFormSubmit(event)">
        <label for="date">Date:</label>
        <input class='dateInput' type="date" name="date" required>

        <label for="season">Season:</label>
        <select name="season" required>
          <option value="1">1</option>
          <option value="2" selected>2</option>
        </select>

        <label for="game">Game Name:</label>
        <select name="game" required>
            <option value="Terraforming Mars">Terraforming Mars</option>
        </select>

        <label>Number of Players (1-5):</label>
        <div id="max_players_buttons">
            <button type="button" onclick="selectPlayerButton(this, 1)">1</button>
            <button type="button" onclick="selectPlayerButton(this, 2)">2</button>
            <button type="button" onclick="selectPlayerButton(this, 3)">3</button>
            <button type="button" onclick="selectPlayerButton(this, 4)">4</button>
            <button type="button" onclick="selectPlayerButton(this, 5)">5</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Points</th>
                    <th>Game Score (Optional)</th>
                </tr>
            </thead>
            <tbody id="player_table_body"></tbody>
        </table>

        <p id="error_message"></p>

        <div class="button-container">
            <button type="submit" id="submit_button">Save Result</button>
        </div>
    </form>

    <!-- Dialog -->
    <div id="dialog" class="dialog">
        <div class="dialog-content">
            <span class="close-btn" onclick="document.getElementById('dialog').style.display='none'">&times;</span>
            <p id="dialog-message"></p>
        </div>
    </div>
</div>

<script>
const playerOptions = ["Alstrup", "Frederik", "Magnus", "Best", "Raschke", "MicrobeMorten"];

function validateUniqueInputs() {
    const playerSelects = document.querySelectorAll(".player-select");
    const pointsSelects = document.querySelectorAll(".points-select");

    const selectedPlayers = Array.from(playerSelects).map(select => select.value);
    const selectedPoints = Array.from(pointsSelects).map(select => select.value);

    const duplicatePlayers = selectedPlayers.filter((value, index, self) => value && self.indexOf(value) !== index);
    const duplicatePoints = selectedPoints.filter((value, index, self) => value && self.indexOf(value) !== index);

    const errorMessage = document.getElementById("error_message");

    if (duplicatePlayers.length > 0 || duplicatePoints.length > 0) {
        errorMessage.textContent = "Error: Duplicate player names or points are not allowed.";
        document.getElementById("submit_button").disabled = true;
    } else {
        errorMessage.textContent = "";
        document.getElementById("submit_button").disabled = false;
    }
}

function handleFormSubmit(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    fetch('/log', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showDialog(data.message);
    })
    .catch(() => showDialog("An error occurred. Please try again."));
}

function showDialog(message) {
    const dialog = document.getElementById('dialog');
    const dialogMessage = document.getElementById('dialog-message');
    dialogMessage.textContent = message;
    dialog.style.display = 'flex';
    setTimeout(() => { dialog.style.display = 'none'; }, 5000);
}

// Close dialog when clicking outside content
document.getElementById('dialog').addEventListener('click', e => {
    if (e.target.id === 'dialog') e.target.style.display = 'none';
});

function selectPlayerButton(el, numPlayers) {
    document.querySelectorAll('#max_players_buttons button').forEach(btn => btn.classList.remove('active'));
    el.classList.add('active');
    updatePlayerTable(numPlayers);
}

function updatePlayerTable(numPlayers) {
    const playerTable = document.getElementById("player_table_body");
    playerTable.innerHTML = "";

    for (let i = 0; i < numPlayers; i++) {
        const row = document.createElement("tr");

        // Player select
        const playerCell = document.createElement("td");
        const playerSelect = document.createElement("select");
        playerSelect.name = "player";
        playerSelect.className = "player-select";
        playerSelect.required = true;
        playerSelect.onchange = validateUniqueInputs;

        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "-- Select Player --";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        playerSelect.appendChild(defaultOption);

        playerOptions.forEach(option => {
            const opt = document.createElement("option");
            opt.value = option;
            opt.textContent = option;
            playerSelect.appendChild(opt);
        });
        playerCell.appendChild(playerSelect);
        row.appendChild(playerCell);

        // Points select
        const pointsCell = document.createElement("td");
        const pointsSelect = document.createElement("select");
        pointsSelect.name = "points";
        pointsSelect.className = "points-select";
        pointsSelect.required = true;
        pointsSelect.onchange = validateUniqueInputs;

        for (let j = 1; j <= 5; j++) {
            const opt = document.createElement("option");
            opt.value = j;
            opt.textContent = j;
            pointsSelect.appendChild(opt);
        }
        pointsCell.appendChild(pointsSelect);
        row.appendChild(pointsCell);

        // Game score select
        const scoreCell = document.createElement("td");
        const scoreSelect = document.createElement("select");
        scoreSelect.name = "game_score";
        const defaultScore = document.createElement("option");
        defaultScore.value = "";
        defaultScore.textContent = "-- Optional --";
        defaultScore.selected = true;
        scoreSelect.appendChild(defaultScore);

        for (let k = 40; k <= 150; k++) {
            const opt = document.createElement("option");
            opt.value = k;
            opt.textContent = k;
            scoreSelect.appendChild(opt);
        }
        scoreCell.appendChild(scoreSelect);
        row.appendChild(scoreCell);

        playerTable.appendChild(row);
    }
}

// Initialize with 4 players active
window.onload = () => {
    const fourthButton = document.querySelectorAll('#max_players_buttons button')[3];
    selectPlayerButton(fourthButton, 4);
};
</script>
{% endblock %}
